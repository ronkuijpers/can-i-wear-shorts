<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT-instellingen</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>.help{font-size:.8rem;color:#4B5563}</style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="max-w-xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold">ðŸ“¡ MQTT</h1>
        <p class="text-sm text-gray-600">Configure MQTT connection and topics</p>
      </div>
      <div class="flex items-center gap-4">
        <a href="/dashboard.html" class="text-sm text-blue-600 hover:underline">Back</a>
        <a href="/logout" class="text-sm text-gray-600 hover:underline">Logout</a>
      </div>
    </header>

    <section class="bg-white p-4 rounded-2xl shadow mb-4">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">Status</h2>
        <div class="flex items-center gap-2">
          <span id="mqttIndicator" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
          <span id="mqttStatus" class="text-sm text-gray-600">-</span>
        </div>
      </div>
      <p id="mqttError" class="text-xs text-red-600"></p>
    </section>

    <section class="bg-white p-4 rounded-2xl shadow mb-4">
      <h2 class="text-xl font-semibold mb-3">Broker</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1" for="host">Hostname or IP</label>
          <input id="host" type="text" placeholder="e.g. 192.168.1.10 or mqtt.local" class="w-full border rounded p-2" />
          <p class="help">Enter the broker the clock should connect to.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="port">Port</label>
          <input id="port" type="number" min="1" max="65535" placeholder="1883" class="w-full border rounded p-2" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1" for="user">User (optional)</label>
            <input id="user" type="text" placeholder="mqtt_user" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="pass">Password (optional)</label>
            <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full border rounded p-2" />
          </div>
        </div>
      </div>
    </section>

    <section class="bg-white p-4 rounded-2xl shadow mb-4">
      <h2 class="text-xl font-semibold mb-3">Home Assistant</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1" for="discovery">Discovery prefix</label>
          <input id="discovery" type="text" placeholder="homeassistant" class="w-full border rounded p-2" />
          <p class="help">Usually <code>homeassistant</code>.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="basetopic">Base topic (device)</label>
          <input id="basetopic" type="text" placeholder="wordclock" class="w-full border rounded p-2" />
          <p class="help">Used as prefix for all states/commands.</p>
        </div>
      </div>
    </section>

    <section class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-xl font-semibold mb-3">Save</h2>
      <p class="text-sm text-gray-600 mb-3">Change settings and save. The clock will try to reconnect immediately.</p>
      <div class="flex gap-2 items-center">
        <button id="saveBtn" class="py-2 px-3 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
        <button id="testBtn" class="py-2 px-3 rounded bg-gray-200 text-gray-800 hover:bg-gray-300">Test connection</button>
        <span id="saveMsg" class="text-sm text-gray-600"></span>
        <a href="/dashboard.html" class="ml-auto py-2 px-3 rounded bg-white border hover:bg-gray-50">Cancel</a>
      </div>
    </section>
  </div>

  <script>
    const qs = id => document.getElementById(id);
    function setStatus(connected, err) {
      const ind = qs('mqttIndicator');
      const st = qs('mqttStatus');
      const er = qs('mqttError');
      if (ind) ind.className = 'inline-block w-3 h-3 rounded-full ' + (connected ? 'bg-green-500' : 'bg-red-500');
      if (st) st.textContent = connected ? 'Connected' : 'Disconnected';
      if (er) er.textContent = err || '';
    }

    async function loadCfg() {
      try {
        const r = await fetch('/api/mqtt/config');
        const j = await r.json();
        qs('host').value = j.host || '';
        qs('port').value = j.port || 1883;
        qs('user').value = j.user || '';
        // do not show password; leave it empty
        qs('discovery').value = j.discovery || 'homeassistant';
        qs('basetopic').value = j.base || 'wordclock';
        // load status
        const s = await fetch('/api/mqtt/status');
        const sj = await s.json();
        setStatus(!!sj.connected, sj.last_error);
      } catch (e) {
        console.error('Failed to load MQTT config', e);
      }
    }
    async function saveCfg() {
      const msg = qs('saveMsg');
      msg.textContent = 'Saving...';
      const form = new URLSearchParams();
      form.set('host', qs('host').value.trim());
      form.set('port', qs('port').value.trim());
      form.set('user', qs('user').value.trim());
      const pw = qs('pass').value; // empty = keep password unchanged
      if (pw) form.set('pass', pw);
      form.set('discovery', qs('discovery').value.trim());
      form.set('base', qs('basetopic').value.trim());
      try {
        const r = await fetch('/api/mqtt/config', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:String(form) });
        if (r.ok) {
          msg.textContent = 'Saved. Reconnecting...';
          qs('pass').value = '';
          setTimeout(() => msg.textContent = '', 5000);
        } else {
          const t = await r.text();
          msg.textContent = 'Failed: ' + t;
        }
      } catch (e) {
        msg.textContent = 'Network error';
      }
    }
    qs('saveBtn').addEventListener('click', saveCfg);
    qs('testBtn').addEventListener('click', async () => {
      const msg = qs('saveMsg');
      msg.textContent = 'Testing...';
      const form = new URLSearchParams();
      form.set('host', qs('host').value.trim());
      form.set('port', qs('port').value.trim());
      form.set('user', qs('user').value.trim());
      const pw = qs('pass').value;
      if (pw) form.set('pass', pw);
      try {
        const r = await fetch('/api/mqtt/test', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:String(form) });
        if (r.ok) {
          msg.textContent = 'Connection OK';
        } else {
          const t = await r.text();
          msg.textContent = 'Failed: ' + t;
        }
      } catch (e) {
        msg.textContent = 'Network error';
      }
      // refresh status after a short delay
      setTimeout(async () => {
        try { const s = await fetch('/api/mqtt/status'); const sj = await s.json(); setStatus(!!sj.connected, sj.last_error); } catch {}
      }, 800);
    });
    loadCfg();
  </script>
</body>
</html>
